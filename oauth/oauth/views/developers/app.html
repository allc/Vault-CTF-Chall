<div>Logged in as {{ username }}</div>
<div>
  <a href="/developers/documents">
    View documents
  </a>
</div>
<h1>Your App {{ app.name }}</h1>
<div>
  <ul>
    <li>Client ID: {{ app.clientId }}</li>
  </ul>
</div>
<div>
  <h2>Generate OAuth2 URL</h2>
  <div>
    <div>Scopes</div>
    <div>
      <input id="scopeUsername" type="checkbox"><label for="scopeUsername">Username</label>
    </div>
    <div>
      <label for="redirect">Redirect URL</label>
      <select id="redirect">
        {% for redirect in app.redirects %}
        <option value="{{ redirect.uri }}">{{ redirect.uri }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="responseType">Redirect URL</label>
      <select id="responseType">
        <option value="code">code</option>
        <option value="token">token</option>
      </select>
    </div>
    <div>
      <button onclick="handleGenerate()">Generate</button>
    </div>
    <div>
      Generated URL: <input id="generated" style="width: 500px;" value="" disabled>
    </div>
  </div>
</div>
<div>
  {% if app.published %}
  Your app is published, you can
  <form action="/developers/app/publish" method="post">
    <input type="hidden" name="csrftoken" value="{{ csrftoken }}">
    <input type="submit" name="action" value="Unpublish">
  </form>
  {% else %}
  When your app is ready, you can
  <form action="/developers/app/publish" method="post">
    <input type="hidden" name="csrftoken" value="{{ csrftoken }}">
    <input type="submit" name="action" value="Publish">
  </form>
  {{ targetUsername }} will review them.
  {% endif %}
</div>
<script>
  function handleGenerate() {
    let result;
    let scopes = [];
    if (document.querySelector('#scopeUsername').checked) {
      scopes.push('username');
    }
    if (scopes.length <= 0) {
      result = 'Please select at least one OAuth2 scope';
    } else {
      const redirectUri = document.querySelector('#redirect').value;
      const responseType = document.querySelector('#responseType').value;
      result = generateUrl(redirectUri, scopes, responseType);
    }
    document.querySelector('#generated').value = result;
  }
  function generateUrl(redirectUri, scopes, responseType) {
    const scopeEncode = encodeURIComponent(scopes.join(' '));
    redirectUri = encodeURIComponent(redirectUri);
    return `{{ oauthApiEndpoint }}/authorize?client_id={{ app.clientId }}&redirect_uri=${redirectUri}&response_type=${responseType}&scope=${scopeEncode}`;
  }
</script>